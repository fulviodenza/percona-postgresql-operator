apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 360
commands:
- script: |-
    kubectl -n ${NAMESPACE} get pg,pod,job
    sleep 5

    primary=$(kubectl -n ${NAMESPACE} get pod -l postgres-operator.crunchydata.com/role=master --no-headers -o jsonpath={.items[].metadata.name} || true)
    if [ -z ${primary} ]; then
            echo "Waiting for pods"
            exit 0
    fi

    phase=$(kubectl -n ${NAMESPACE} get pod/${primary} -o jsonpath={".status.phase"})
    if [[ "${phase}" != "Running" ]]; then
            echo "Waiting for ${primary} to start running"
            exit 0
    fi

    kubectl -n ${NAMESPACE} exec -it ${primary} -- patronictl list
    kubectl -n ${NAMESPACE} exec -it ${primary} -- patronictl history

    sleep 10
---
apiVersion: pgv2.percona.com/v2
kind: PerconaPGCluster
metadata:
  name: major-upgrade
spec:
  postgresVersion: 13
status:
  pgbouncer:
    ready: 3
    size: 3
  postgres:
    instances:
    - name: instance1
      ready: 3
      size: 3
    ready: 3
    size: 3
  state: ready
---
kind: Job
apiVersion: batch/v1
metadata:
  labels:
    postgres-operator.crunchydata.com/cluster: major-upgrade
    postgres-operator.crunchydata.com/pgbackrest: ''
    postgres-operator.crunchydata.com/pgbackrest-backup: replica-create
    postgres-operator.crunchydata.com/pgbackrest-repo: repo1
  ownerReferences:
    - apiVersion: pgv2.percona.com/v2
      kind: PerconaPGBackup
      controller: true
      blockOwnerDeletion: true
status:
  succeeded: 1
